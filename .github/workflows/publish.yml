name: Publish Rhino Linux Images
on: workflow_dispatch

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3.5.0
        with:
          path: os
      
      - name: Change APT repository URLs because of the Ubuntu Archive slowdowns
        run: sudo sed -i 's/azure\.archive\.ubuntu\.com/mirrors.mit.edu/g' /etc/apt/sources.list
        
      - name: Update APT cache
        run: sudo apt-get update

      - name: Install rclone
        run: sudo apt-get install rclone -y

      - name: Set up rclone config
        run: |
          # Normally we'd be able to run something like
          # 'rclone config create ...', but that isn't working for some reason.
          # So we'll make the config manually instead.
          #
          # See https://github.com/rhino-linux/os/actions/runs/5396018584/jobs/9799166656
          # as an example.
          mkdir ~/.config/rclone
          echo "
          [sourceforge]
          type = sftp
          host = frs.sourceforge.net
          pass = ${{ secrets.SOURCEFORGE_PASS }}
          use_insecure_cipher = true
          shell_type = unix
          md5sum_command = none
          sha1sum_command = none
          " > ~/.config/rclone/rclone.conf

      - name: Download release assets from latest CI run
        run: gh run download -p '*' "$(gh run list -w devel.yml --json databaseId -q '.[].databaseId' -L 1)"
        env:
          GH_TOKEN: "${{ github.token }}"
          GH_REPO: "${{ github.repository }}"

      - name: Upload assets to SourceForge
        run: |
          source os/etc/terraform.conf
          HEADVER="${VERSION}${SUBVER}"
          PHONE="${HEADVER}-pinephone"
          TAB="${HEADVER}-pinetab"
          RPI="${HEADVER}-rpi"
          for image in *.iso *.img.xz; do
            case "${image}" in 
              *iso)
                TRUEVER="$HEADVER"
                ;;
              *phone*)
                TRUEVER="$PHONE"
                ;;
              *tab*)
                TRUEVER="$TAB"
                ;;
              *rpi*)
                TRUEVER="$RPI"
                ;;
            esac
            if ! [[ -d "${TRUEVER}/" ]]; then
              mkdir "${TRUEVER}/"
            fi
            mv "${image}"/"${image}" "${TRUEVER}/"
            sha256sum "${TRUEVER}/${image}" >> "${TRUEVER}/${image}".sha256
            rclone copyto --progress "${TRUEVER}/${image}.sha256" "sourceforge:/home/frs/project/rhino-linux-builder/${TRUEVER}/${image}.sha256"
            rclone copyto --progress "${TRUEVER}/${image}" "sourceforge:/home/frs/project/rhino-linux-builder/${TRUEVER}/${image}";
          done
